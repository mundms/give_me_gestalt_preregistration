---
title: "Practical Class: Data Analysis for the Mental Rotation Task"
output: html_document
---

# Instructions
* Download [this zip file](https://michael-franke.github.io/XPLab_2019/handouts/mental_rotation_analysis.zip). 
* Download the results file from Stud.IP.
* Open the .Rmd file in RStudio.
* Fill in the code required (ask for help if needed!)
* When you're done: 'Knit' the document (`ctrl/cmd` + `shift` + `K` in RStudio) to produce a HTML file.

# Suggested resources
* [RStudio cheatsheets](https://www.rstudio.com/resources/cheatsheets/).

# Required R packages
* `tidyverse` (or `ggplot2`, `dplyr`, `purrr`, `tibble`)
* `brms`
* `devtools` (for installing `faintr`)
* `rstan`
* `faintr` (install with `devtools`)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)

```

Load the required packages and set a seed for the random number generator.
```{r}
library(tidyverse)

library(rstan)
# set cores to use to the total number of cores (minimally 4)
options(mc.cores = max(parallel::detectCores(), 4))
# save a compiled version of the Stan model file
rstan_options(auto_write = TRUE)

library(brms)

# install faintr with devtools::install_github('michael-franke/bayes_mixed_regression_tutorial/faintr', build_vignettes = TRUE))
library(faintr)


set.seed(123)

```

Step 1. Read the data and take a glimpse of it.
---
Use `read_csv()` and `glimpse()`

```{r}
data_raw <- read_csv("190705_prereg.csv")
glimpse(data_raw)
```


Step 2. Select only the columns of interest.
---
Do this with the `select()` command.

```{r}
select(data_raw, submission_id, trial_name, trial_number, fileID, response, RT, timeSpent)
data_selection <- select(data_raw, submission_id, trial_name, trial_number, fileID, response, RT, timeSpent)
filter(data_selection, 3000 < RT, RT < 180000)
data_filtered <- filter(data_selection, 0000 < RT, RT < 1800000)
```


Step 3. Change columns to the correct data type.
data_mutation <- mutate(data_filtered, condition=factor(expected), correctness=factor(correctness), angle=factor(angle), trial_type=factor(trial_type))
---
Use `mutate()`:
* `expected` should be a factor (also rename this to `condition`)
* `correctness` should be a factor
* `angle` should be a factor
* `trial_type` should be a factor

```{r}
data_mutation <- mutate(data_filtered, response=ordered(response))
data_snellen <- filter(data_mutation, trial_name == "test_snellen")
data_b1 <- filter(data_mutation, trial_name == "b1_exp")
data_b2 <- filter(data_mutation, trial_name == "b2_exp")



```


Step 4. Show the data frame.
---

Check that everything is there and of the correct type.

```{r}
show(data_mutation)
show(data_snellen)
show(data_b1)
show(data_b2)
```



Step 5. Filter only the 'main' trials with correct responses.
---

Use `filter()`.

data_main_correct <- filter(data_mutation, trial_type == "main" & correctness == "correct")
show(data_main_correct)

```{r}
data_b1
data_b1_mean
```


```{r}

```


Step 6. Make a boxplot of the data.
---

Show condition (same/different) on the x-axis and RT on the y-axis.
Show the different angles in different colors (fill). (use `ggplot()` and `geom_boxplot`)

```{r}
ggplot(data_main_correct, aes(condition, RT, fill=angle)) + geom_boxplot()
```



Step 7. Remove outliers
---

Use `filter()` to filter only response times that are in a reasonable range.

```{r}
data_reasonable <- filter(data_main_correct, RT >= mean(RT)-sd(RT)*2, RT <= mean(RT)+sd(RT))
ggplot(data_reasonable, aes(condition, RT, fill=angle)) + geom_boxplot()
```


Step 8. Show means for each design cell.
---

Use `group_by() %>% summarise()`.

```{r}
data_means <- group_by(data_reasonable, condition, angle) %>% summarise(mean=mean(RT))
show(data_means)
```



Step 9. Run a bayesian fixed-effects model 
---
Use `brm` to model the response times from angle, condition and angle*condition.


```{r}
data_brm <- brm(RT ~ angle*condition, data=data_reasonable)
summary(data_brm)
```



Step 10. See how probable the following hypotheses are:
---
Use `faintr::compare_groups()`

"Responses to 'same' trials are faster than responses to 'different' trials.

```{r}
faintr::compare_groups(model=data_brm, lower=list(condition="same"), higher=list(condition="different"))
```
 


"Responses to '50 degree' trials are faster than responses to '150 degree' trials.
```{r}
faintr::compare_groups(model=data_brm, lower=list(angle="50"), higher=list(angle="150"))
```



"Angle matters more than same/different for response times". (In other words, when the angle is lower but the objects are 'different', people are still faster than when the angle is higher but the objects are the 'same'.)

```{r}
faintr::compare_groups(model=data_brm, lower=list(angle="50", condition="different"), higher=list(angle="150", condition="same"))
```



Step 11. Run the model again, but this time include random effects
---

Include random by-item intercepts (`+ (1|item)`).


```{r}
data_brm_re <- brm(RT ~ angle*condition + (1|item), data=data_reasonable)
```



Step 12. Check the same hypotheses for the mixed effects model
---

```{r}
faintr::compare_groups(model=data_brm_re, lower=list(condition="same"), higher=list(condition="different"))

faintr::compare_groups(model=data_brm_re, lower=list(angle="50"), higher=list(angle="150"))

faintr::compare_groups(model=data_brm_re, lower=list(angle="50", condition="different"), higher=list(angle="150", condition="same"))
```



Step 13. Conclude
---

The probabilities of the fixed-effects model and the mixed-effects model are not significantly different. With probabilities over 99% all hypotheses ('same' faster than 'different', '50 degree' faster than '150 degree', angle matters more than same/different) are true.

___

End of sheet.
